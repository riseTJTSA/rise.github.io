<!DOCTYPE html>

<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />

    <title>RISE</title>
    <link href="../vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/spinner.css" rel="stylesheet" type="text/css">
    <link href="../vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Merriweather:400,300,300italic,400italic,700,700italic,900,900italic' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.2/css/bootstrap-select.min.css">
    <link href="../vendor/magnific-popup/magnific-popup.css" rel="stylesheet">

    <link href="../css/creative.min_1.css" rel="stylesheet">
    <link href="../css/style.css" rel="stylesheet">
    <link rel="shortcut icon" href="Main Page/launcher-icon-4x.png" type="image/x-icon">

</head>

<body id="page-top">

<div id="to-hide">

    <center>

    <section class="bg-light" id="section">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col
                -lg-offset-2 text-center">
                    <h2 class="section-heading" id = "studentNameHeader"> Welcome !</h2>
                    <hr class="primary">
                    <h3 class="text-muted" id ="ineedatutor">I need a tutor in
                        <select class="selectpicker" multiple title="Select a subject" multiple data-max-options="1" id= "subjectPicker" >
                          <optgroup label="Math" >
                            <option data-tokens="math, algebra 1">Algebra 1</option>
                            <option data-tokens="math ,geometry">Geometry</option>
                            <option data-tokens="math, algebra 2">Algebra 2</option>
                            <option data-tokens="math, Precalculus">Precalculus</option>
                            <option data-tokens="math, Calculus, Calculus AB, Calculus BC">Calculus AB and BC</option>
                            <option data-tokens="math, advanced math, multi, multivariable calculus">Advanced Math</option>
                          </optgroup>
                          <optgroup label="Science" >
                            <option data-tokens="science, bio, biology">Biology</option>
                            <option data-tokens="science, chem, chemistry">Chemistry</option>
                            <option data-tokens="science, physics">Physics</option>
                            <option data-tokens="science, geo, geosystems">Geosystems</option>
                          </optgroup>
                          <optgroup label="Computer Science" >
                            <option data-tokens="Computer Science, cs, foundations of Computer Science">Foundations of Computer Science</option>
                            <option data-tokens="Computer Science, cs, AP Computer Science, APCS">AP Computer Science</option>
                            <option data-tokens="Computer Science, cs, AI, Aritifical Intelligence">Artificial Intelligence</option>
                            <option data-tokens="Computer Science, cs, advanced computer science, parallel computing, computer vision">Advanced Computer Science</option>
                          </optgroup>
                          <optgroup label="Humanities" >
                            <option data-tokens="Humanities, hum, World History">World History</option>
                            <option data-tokens="Humanities, hum, AP US History, APUSH">AP US History</option>
                            <option data-tokens="Humanities, hum, European History">European History</option>
                            <option data-tokens="Humanities, hum, other history courses">Other History</option>
                          </optgroup>
                        </select>
                    </h3>





<h3 class="text-muted" id="tutoravail" style="visibility: hidden;"> I would like to be tutored by
<select class="selectpicker" multiple title="Finding tutors..." multiple data-max-options="1" id= "tutorPicker1" >
</select>

</h3>



<h3 class="text-muted" id ="locationsAvail" style="visibility:hidden;"">I will be tutored at
   <!-- <select class=".selectpicker" data-live-search="true" title="Select a location" data-max-options="1" id= "locpicker">

</select>. -->
</h3>

<iframe
  id="google_map"
  style="display: none;"
  width="600"
  height="300"
  frameborder="0" style="border:0"
  src="https://www.google.com/maps/embed/v1/place?key=AIzaSyDKEVPKH_VCpNWSlMsAbNwWzOqkwl9LtJU
    &q=TJHSST" allowfullscreen>
</iframe>

<h3 style="display: none;" id="confirm_para">Is this okay? Click the button below to confirm this or select another tutor.</h3>

<a style="display: none;" id="confirm_button" onclick="confirmTutor()" style="width: 200px;" class="btn-custom btn btn-primary btn-xl page-scroll">Confirm</a>





</div>
<div>

</div>


                </div>
            </div>
        </div>
    </section>
    </center>
    <div id="myNav" class="overlay">
  <div class="overlay-content">
  <h1 class="findingatutor" id="loadingScreen">RISE is finding a tutor near you</h1>
   <div class="spinner" id="loading"></div>
  </div>
</div>





<!--    <footer class="footer">
      <div class="container">
      <center>
        <p class="text-muted">&copy; 2017 TJHSST TSA  </p>
        </center>
      </div>
    </footer> -->
    <!-- <script src="StudentLogin.js"></script> -->
    <script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
    <!-- jQuery -->
    <script src="../vendor/jquery/jquery.min.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="../vendor/bootstrap/js/bootstrap.min.js"></script>

    <!-- Plugin JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.3/jquery.easing.min.js"></script>
    <script src="../vendor/scrollreveal/scrollreveal.min.js"></script>
    <script src="vendor/magnific-popup/jquery.magnific-popup.min.js"></script>

    <!-- Theme JavaScript -->
    <script src="../js/creative.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/3.9.0/firebase.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.2/js/bootstrap-select.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.2/js/i18n/defaults-*.min.js"></script>
    <script>if (window.module) module = window.module;</script>

<script>

var TUTOR_EMAIL;
var TUTEE_EMAIL;
var SUBJECT;
var ADDRESS;
var MAP_LINK;

 var userId = "NOT A VALID USER";
//   // Initialize Firebase
   var config = {
    apiKey: "AIzaSyC54QaF7lPx-tYYARGNXWlpD6EmZp2cXXk",
    authDomain: "rise-student.firebaseapp.com",
    databaseURL: "https://rise-student.firebaseio.com",
    projectId: "rise-student",
    storageBucket: "rise-student.appspot.com",
    messagingSenderId: "936274072255"
  };
  var selectedSubject = "NONE";
  var selectedTutor = "NONE";
  var selectedLocation = "NONE";
  firebase.initializeApp(config);
  const auth = firebase.auth();
  var database = firebase.database();
  var userId = "abcdef";
  var email2 = "";
  var loc = "none";


  var tutor_map = new Map();

  auth.onAuthStateChanged(firebaseUser => {
    if (firebaseUser){
        userId = auth.currentUser["email"];
        TUTEE_EMAIL = userId;
        console.log(auth["currentUser"]["email"]);
        email2 = userId.replace(".", "-");
        database.ref('/students/' + email2).once('value').then(function(snapshot) {
            var username = snapshot.val()["name"];
            console.log(username);
            loc = snapshot.val()["location"];
            $("#studentNameHeader").html("Welcome " + username + "!");

        });
    }
    else{
        console.log("no one is logged on");
        $("ineedatutor").html("You must log in. Please visit the RISE home page!");
        //window.location.href ="index.html";
    }

  });

  var x = "none";
  var tutorEmails = [];
  var tutorNames = [];
  var select = "";
  var res = "";
$(function() {

  var change = function( txt ) {
        $("#ID").append( '<li>' + txt + '</li>' );
    };
    change("this is the first change");
    change("this is the second change");



$("ul").on('click', 'li', function () {
   var id = this.id;
   //play with the id
});



  $('#subjectPicker').on('change', function(){
    selectedSubject = $(this).find("option:selected").val();
    SUBJECT = selectedSubject;
   console.log(email2);
   writeUserData(userId.replace(".","-"), loc);
//   var tutorPickerElement = document.getElementById("tutorpicker");
    var yql_url = 'https://query.yahooapis.com/v1/public/yql/';
    var url = encodeURI('https://rise-api.herokuapp.com/tutor?subject='+selectedSubject+'&tutee_address='+loc.replace(" ", "%"));
    console.log(url);
    // $.getJSON(url, function(response){
    //     res = response;
    //    console.log(response);
    //    $('#tutorpicker').find('option').remove();
    //    tutorEmails = response["query"]["results"]["json"];
    //    tutorEmails.unshift("Select a tutor");
    //    for (i = 0; i < tutorEmails.length; i++) {
    //     var a = document.getElementById("tutorpicker");
    //     var option = document.createElement("option");
    //     option.text = tutorEmails[i];
    //     a.add(option);
    //   }
    // });
    $.ajax({
    'url': yql_url,
    'data': {
    'q': 'SELECT * FROM json WHERE url="'+url+'"',
    'format': 'json',
    'jsonCompat': 'new',
     },
    'dataType': 'jsonp',

    'success': function(response) {
      res = response;
       console.log(response);
//       $('#tutorpicker').find('option').remove();
       tutorEmails = response["query"]["results"]["json"]["json"];
       tutorEmails.unshift("Loading tutors....");
//       for (i = 0; i < tutorEmails.length; i++) {
//        var a = document.getElementById("tutorpicker");
//        var option = document.createElement("option");
//        option.text = tutorEmails[i];
//        a.add(option);
//     }

     var tutorPickerElement1 = document.getElementById("tutorPicker1");
       $('#tutorPicker1').find('option').remove();
       var b = document.getElementById("tutorPicker1");
     var optionText;
     // optionText = "";
     console.log(tutorEmails);
     t_text = "";
     for(var j = 1; j < tutorEmails.length;j++){
          database.ref('tutors/' + tutorEmails[j]).once('value').then(function(snapshot) {
            var name = snapshot.val()["name"];
            tutor_map.set(name, snapshot.val()["email"]);
            //console.log(name)
            t_text = t_text + "<option>" + name + "</option>";
          });
     }
     setTimeout(function(){
        $("#tutorPicker1").html(t_text).selectpicker('refresh');
        $("#tutorPicker1").selectpicker({title: 'Select a tutor'}).selectpicker('refresh');
        //document.getElementById("tutorPicker1").setAttribute("title", "Select a tutor").selectpicker('refresh');
      }, 2000);
     // while(optionText == ""){
     //  // setTimeout(function(){
     //  //   optionText = t_text;
     //  // }, 10); 
     // }
     // console.log(optionText);
//      for (i = 1; i < tutorEmails.length; i++) {
//           // database.ref('tutors/' + tutorEmails[i]).once('value').then(function(snapshot) {
//           //   var name = snapshot.val()["name"];
//           //   console.log(name)
//           //   optionText = optionText + "<option>" + name + "</option>";
//           // });
//           optionText = optionText + "<option>" + tutorEmails[i] + "</option>";
//         }
// //      b.innerHTML = optionText;

      

    }
    });


    document.getElementById("tutoravail").style.visibility = "visible";
    $('#tutorPicker1').on('change', function(){

          console.log(tutor_map);

          selectedTutor = $(this).find("option:selected").val();
          console.log(selectedTutor);
          database.ref('/tutors/' + tutor_map.get(selectedTutor).replace(".", "-")).once('value').then(function(snapshot) {
            var tutorLoc = snapshot.val()["tutorloc"];
            TUTOR_EMAIL = snapshot.val()["email"];
            ADDRESS = tutorLoc;
            document.getElementById("locationsAvail").innerHTML = "I will be tutored at " + tutorLoc +".";
            document.getElementById("locationsAvail").style.visibility = "visible";
            document.getElementById("confirm_button").setAttribute("style", "");
            document.getElementById("confirm_para").setAttribute("style", "");
            map = document.getElementById("google_map");
            lnk = "https://www.google.com/maps/embed/v1/place?key=AIzaSyDKEVPKH_VCpNWSlMsAbNwWzOqkwl9LtJU&q=" + replaceAll(tutorLoc, " ", "+");
            console.log(lnk);
            map.setAttribute("src", lnk);
            MAP_LINK = "http://google.com/maps?q=" + replaceAll(tutorLoc, " ", "+");
            map.setAttribute("style", "");

        });


    });
      });

});

function writeUserData(email2, loc) {
  database.ref('/subjects-students/' + selectedSubject.replace(" ", "-")).set({
    email : email2
  });
}

function confirmTutor(){

  //MAP_LINK = document.getElementById("google_map").getAttribute("src");
  console.log(TUTOR_EMAIL);
  console.log(TUTEE_EMAIL);
  console.log(SUBJECT);
  console.log(ADDRESS);
  console.log(MAP_LINK);

  // console.log()

  var yql_url = 'https://query.yahooapis.com/v1/public/yql/';
  var url = encodeURI('https://rise-api.herokuapp.com/send_email?tutor_addr='+TUTOR_EMAIL+'&tutee_addr='+TUTEE_EMAIL+'&subject='+SUBJECT+'&address='+ADDRESS+'&map_link='+MAP_LINK);
  console.log(url);

  $.ajax({
    'url': yql_url,
    'data': {
    'q': 'SELECT * FROM json WHERE url="'+url+'"',
    'format': 'json',
    'jsonCompat': 'new',
     },
    'dataType': 'jsonp',

    'success': function(response) {
      res = response;
      console.log(response);
      path = '/subjects-tutors/'+SUBJECT+"/"+TUTOR_EMAIL.replace(".", "-");
      console.log(path)
      database.ref(path).remove();
      document.getElementById("confirm_para").innerHTML = "Confirmation sent! Have a good tutoring session!<br>(You can close this window now)";
      document.getElementById("confirm_button").setAttribute("disabled", "true");
    }
  });
}

function replaceAll(str, find, replace) {
  return str.replace(new RegExp(find, 'g'), replace);
}

</script>
</body>

</html>
